{% extends "admin/base.html" %}

{% block title %}{% if associado %}Editar{% else %}Novo{% endif %} Associado{% endblock %}

{% block page_title %}{% if associado %}Editar{% else %}Novo{% endif %} Associado{% endblock %}

{% block content %}
<div class="admin-card">
    <form method="POST" class="admin-form" enctype="multipart/form-data">
        <div class="form-group">
            <label for="nome_completo">Nome Completo *</label>
            <input type="text" id="nome_completo" name="nome_completo" 
                   value="{% if associado %}{{ associado.nome_completo }}{% endif %}" required>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="cpf">CPF *</label>
                <input type="text" id="cpf" name="cpf" 
                       value="{% if associado %}{{ associado.cpf }}{% endif %}" 
                       placeholder="000.000.000-00" required
                       maxlength="14">
                <small style="color: var(--text-light);">Formato: 000.000.000-00</small>
            </div>
            
            <div class="form-group">
                <label for="data_nascimento">Data de Nascimento *</label>
                <input type="date" id="data_nascimento" name="data_nascimento" 
                       value="{% if associado %}{{ associado.data_nascimento.strftime('%Y-%m-%d') }}{% endif %}" required>
            </div>
        </div>
        
        <div class="form-group">
            <label for="endereco">Endere√ßo *</label>
            <textarea id="endereco" name="endereco" rows="3" required>{% if associado %}{{ associado.endereco }}{% endif %}</textarea>
            <small style="color: var(--text-light);">Rua, n√∫mero, bairro, cidade - CEP</small>
        </div>
        
        <div class="form-group">
            <label for="telefone">Telefone *</label>
            <input type="text" id="telefone" name="telefone" 
                   value="{% if associado %}{{ associado.telefone }}{% endif %}" 
                   placeholder="(00) 00000-0000" required
                   maxlength="20">
            <small style="color: var(--text-light);">Formato: (00) 00000-0000</small>
        </div>
        
        <div class="form-group" style="border-top: 2px solid #e5e7eb; padding-top: 1.5rem; margin-top: 1rem;">
            <label for="foto" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">Foto do Associado</label>
            {% if associado and associado.foto %}
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; border: 2px solid #d1d5db;">
                <p style="margin: 0 0 0.5rem 0; color: #374151; font-weight: 500;">
                    <span>üì∑</span> Foto atual:
                </p>
                {% if associado.foto.startswith('base64:') and associado.foto_base64 %}
                    {% set mime = associado.foto.split(':', 1)[1] %}
                    <img src="data:{{ mime }};base64,{{ associado.foto_base64 }}" alt="Foto do associado"
                         style="max-width: 200px; max-height: 200px; border-radius: 0.5rem; border: 2px solid #d1d5db; display: block; margin-top: 0.5rem;">
                {% else %}
                    <img src="{{ url_for('static', filename=associado.foto) }}" alt="Foto do associado" 
                         style="max-width: 200px; max-height: 200px; border-radius: 0.5rem; border: 2px solid #d1d5db; display: block; margin-top: 0.5rem;">
                {% endif %}
                <small style="color: #6b7280; display: block; margin-top: 0.5rem;">Fa√ßa upload de uma nova foto para substituir a atual</small>
            </div>
            {% endif %}
            <input type="file" id="foto" name="foto" accept="image/*" 
                   style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; background: white;">
            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                Formatos aceitos: JPG, PNG, GIF. Tamanho m√°ximo recomendado: 2MB
            </small>
        </div>
        
        <div class="form-group">
            <label for="senha">Senha {% if associado %}(deixe em branco para manter a atual){% else %}*{% endif %}</label>
            <input type="password" id="senha" name="senha" 
                   placeholder="{% if associado %}Nova senha (m√≠nimo 6 caracteres){% else %}M√≠nimo 6 caracteres{% endif %}"
                   {% if not associado %}required{% endif %}
                   minlength="6">
            <small style="color: var(--text-light);">A senha deve ter no m√≠nimo 6 caracteres</small>
        </div>
        
        <div class="form-group">
            <label for="tipo_associado">Tipo de Associado *</label>
            <select id="tipo_associado" name="tipo_associado" required>
                <option value="regular" {% if associado and associado.tipo_associado == 'regular' %}selected{% endif %}>üë§ Associado Regular (n√£o paga mensalidade)</option>
                <option value="contribuinte" {% if not associado or associado.tipo_associado == 'contribuinte' %}selected{% endif %}>üí∞ Associado Contribuinte (paga mensalidade)</option>
            </select>
            <small style="color: var(--text-light);">
                Associados Regulares n√£o pagam mensalidade. Associados Contribuintes pagam mensalidade conforme valor configurado.
            </small>
        </div>
        
        <div class="form-group" id="valor_mensalidade_group">
            <label for="valor_mensalidade">Valor da Mensalidade (R$)</label>
            <input type="number" 
                   id="valor_mensalidade" 
                   name="valor_mensalidade" 
                   step="0.01" 
                   min="0" 
                   value="{% if associado and associado.valor_mensalidade %}{{ associado.valor_mensalidade }}{% endif %}" 
                   class="form-input"
                   placeholder="0.00">
            <small style="color: var(--text-light);">
                {% if associado %}
                    Ao alterar o valor, todas as mensalidades j√° emitidas (exceto as pagas) ser√£o atualizadas automaticamente.
                {% else %}
                    Valor da mensalidade que ser√° cobrado mensalmente. Se informado, as mensalidades ser√£o geradas automaticamente ap√≥s o cadastro.
                {% endif %}
            </small>
        </div>
        
        {% if associado %}
        <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status" required>
                <option value="pendente" {% if associado.status == 'pendente' %}selected{% endif %}>‚è≥ Pendente</option>
                <option value="aprovado" {% if associado.status == 'aprovado' %}selected{% endif %}>‚úÖ Aprovado</option>
                <option value="negado" {% if associado.status == 'negado' %}selected{% endif %}>‚ùå Negado</option>
            </select>
            <small style="color: var(--text-light);">Status do cadastro do associado</small>
        </div>
        {% endif %}
        
        <div class="form-actions">
            <button type="submit" class="btn-admin btn-admin-primary">
                <span>üíæ</span> Salvar
            </button>
            <a href="{{ url_for('admin_associados') }}" class="btn-admin btn-admin-secondary">
                <span>‚Ü©Ô∏è</span> Cancelar
            </a>
        </div>
    </form>
</div>

<script>
// M√°scara para CPF
document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            }
        });
    }
    
    // M√°scara para telefone
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                } else {
                    value = value.replace(/(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            }
        });
    }
    
    // Mostrar/ocultar campo de valor de mensalidade baseado no tipo de associado
    const tipoAssociadoSelect = document.getElementById('tipo_associado');
    const valorMensalidadeGroup = document.getElementById('valor_mensalidade_group');
    const valorMensalidadeInput = document.getElementById('valor_mensalidade');
    
    function atualizarVisibilidadeMensalidade() {
        if (tipoAssociadoSelect.value === 'regular') {
            valorMensalidadeGroup.style.display = 'none';
            valorMensalidadeInput.value = '0';
        } else {
            valorMensalidadeGroup.style.display = 'block';
        }
    }
    
    if (tipoAssociadoSelect) {
        atualizarVisibilidadeMensalidade();
        tipoAssociadoSelect.addEventListener('change', atualizarVisibilidadeMensalidade);
    }
});
</script>
{% endblock %}

