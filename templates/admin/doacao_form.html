{% extends "admin/base.html" %}

{% block title %}{% if doacao %}Editar{% else %}Nova{% endif %} Doa√ß√£o{% endblock %}

{% block page_title %}{% if doacao %}Editar{% else %}Nova{% endif %} Doa√ß√£o{% endblock %}

{% block content %}
<div class="admin-card">
    <div class="admin-card-header">
        <h2 class="admin-card-title">{% if doacao %}Editar{% else %}Nova{% endif %} Doa√ß√£o</h2>
        <a href="{{ url_for('admin_contas') }}" class="btn-admin btn-admin-secondary">
            <span>‚Üê</span> Voltar
        </a>
    </div>
    
    <form method="POST" class="admin-form">
        <div class="form-group">
            <label for="tipo">Tipo de Doa√ß√£o *</label>
            <select id="tipo" name="tipo" class="form-input" required onchange="atualizarCampos()">
                <option value="">Selecione o tipo</option>
                <option value="financeira" {% if doacao and doacao.tipo == 'financeira' %}selected{% endif %}>üí∞ Financeira (Dinheiro)</option>
                <option value="material" {% if doacao and doacao.tipo == 'material' %}selected{% endif %}>üì¶ Material</option>
                <option value="servico" {% if doacao and doacao.tipo == 'servico' %}selected{% endif %}>üõ†Ô∏è Presta√ß√£o de Servi√ßo</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="descricao">Descri√ß√£o *</label>
            <textarea id="descricao" name="descricao" rows="3" required>{% if doacao %}{{ doacao.descricao }}{% endif %}</textarea>
        </div>
        
        <div class="form-group">
            <label for="doador">Doador</label>
            <input type="text" id="doador" name="doador" 
                   value="{% if doacao %}{{ doacao.doador }}{% endif %}" 
                   class="form-input"
                   placeholder="Nome do doador">
        </div>
        
        <div class="form-group">
            <label for="pais">Pa√≠s do Doador *</label>
            <select id="pais" name="pais" class="form-input" required onchange="atualizarCamposPorPais()">
                <option value="">Selecione o pa√≠s</option>
{% include 'admin/paises_options.html' %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="telefone">Telefone do Doador</label>
            <input type="text" id="telefone" name="telefone" 
                   value="{% if doacao %}{{ doacao.telefone }}{% endif %}" 
                   class="form-input"
                   placeholder="Digite o telefone"
                   maxlength="50">
            <small style="color: var(--text-light);" id="telefone_help">Formato ser√° definido pelo pa√≠s selecionado</small>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="tipo_documento">Tipo de Documento</label>
                <select id="tipo_documento" name="tipo_documento" class="form-input" onchange="atualizarMascaraDocumento(true)">
                    <option value="">Selecione</option>
                </select>
                <small style="color: var(--text-light);" id="documento_help">Tipos dispon√≠veis conforme o pa√≠s</small>
            </div>
            
            <div class="form-group">
                <label for="documento">Documento</label>
                <input type="text" id="documento" name="documento" 
                       value="{% if doacao and doacao.documento %}{{ doacao.documento }}{% endif %}" 
                       class="form-input"
                       maxlength="30"
                       placeholder="Digite o documento">
            </div>
        </div>
        
        <div class="form-group" id="campo_valor" style="display: none;">
            <label for="valor">Valor (R$) *</label>
            <input type="number" id="valor" name="valor" 
                   step="0.01" min="0" 
                   value="{% if doacao and doacao.valor %}{{ doacao.valor }}{% endif %}" 
                   class="form-input"
                   placeholder="0.00">
        </div>
        
        <div class="form-group" id="campo_quantidade" style="display: none;">
            <label for="quantidade">Quantidade *</label>
            <input type="number" id="quantidade" name="quantidade" 
                   min="0" 
                   value="{% if doacao and doacao.quantidade %}{{ doacao.quantidade }}{% endif %}" 
                   class="form-input"
                   placeholder="0">
        </div>
        
        <div class="form-group" id="campo_unidade" style="display: none;">
            <label for="unidade">Unidade</label>
            <input type="text" id="unidade" name="unidade" 
                   value="{% if doacao %}{{ doacao.unidade }}{% endif %}" 
                   class="form-input"
                   placeholder="{% if doacao and doacao.tipo == 'servico' %}Ex: horas, dias{% else %}Ex: kg, litros, unidades{% endif %}">
        </div>
        
        <div class="form-group">
            <label for="data_doacao">Data da Doa√ß√£o *</label>
            <input type="date" id="data_doacao" name="data_doacao" 
                   value="{% if doacao %}{{ doacao.data_doacao.strftime('%Y-%m-%d') }}{% else %}{{ date.today().strftime('%Y-%m-%d') }}{% endif %}" 
                   required>
        </div>
        
        <div class="form-group">
            <label for="observacoes">Observa√ß√µes</label>
            <textarea id="observacoes" name="observacoes" rows="3">{% if doacao %}{{ doacao.observacoes }}{% endif %}</textarea>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-admin btn-admin-primary">
                <span>üíæ</span> Salvar
            </button>
            <a href="{{ url_for('admin_contas') }}" class="btn-admin btn-admin-secondary">
                Cancelar
            </a>
        </div>
    </form>
</div>

<script>
function atualizarCampos() {
    const tipo = document.getElementById('tipo').value;
    const campoValor = document.getElementById('campo_valor');
    const campoQuantidade = document.getElementById('campo_quantidade');
    const campoUnidade = document.getElementById('campo_unidade');
    const inputValor = document.getElementById('valor');
    const inputQuantidade = document.getElementById('quantidade');
    
    // Esconder todos os campos
    campoValor.style.display = 'none';
    campoQuantidade.style.display = 'none';
    campoUnidade.style.display = 'none';
    
    // Remover required
    inputValor.removeAttribute('required');
    inputQuantidade.removeAttribute('required');
    
    if (tipo === 'financeira') {
        campoValor.style.display = 'block';
        inputValor.setAttribute('required', 'required');
    } else if (tipo === 'material' || tipo === 'servico') {
        campoQuantidade.style.display = 'block';
        campoUnidade.style.display = 'block';
        inputQuantidade.setAttribute('required', 'required');
        
        // Atualizar placeholder da unidade
        const inputUnidade = document.getElementById('unidade');
        if (tipo === 'servico') {
            inputUnidade.placeholder = 'Ex: horas, dias';
        } else {
            inputUnidade.placeholder = 'Ex: kg, litros, unidades';
        }
    }
}

// Configura√ß√µes por pa√≠s
const configPaises = {
    'BR': {
        ddi: '+55',
        telefone: { format: 'br', placeholder: '+55 (00) 00000-0000' },
        documentos: [
            { value: 'cpf', label: 'CPF (Pessoa F√≠sica)', maxLength: 14, placeholder: '000.000.000-00' },
            { value: 'cnpj', label: 'CNPJ (Pessoa Jur√≠dica)', maxLength: 18, placeholder: '00.000.000/0000-00' }
        ]
    },
    'AR': {
        ddi: '+54',
        telefone: { format: 'ar', placeholder: '+54 (000) 000 0000' },
        documentos: [
            { value: 'cuil', label: 'CUIL (Pessoa F√≠sica - CPF)', maxLength: 13, placeholder: '00-00000000-0' },
            { value: 'cuit', label: 'CUIT (Pessoa Jur√≠dica - CNPJ)', maxLength: 13, placeholder: '00-00000000-0' }
        ]
    },
    'UY': {
        ddi: '+598',
        telefone: { format: 'uy', placeholder: '+598 0000 0000' },
        documentos: [
            { value: 'ruc', label: 'RUC (Pessoa Jur√≠dica)', maxLength: 12, placeholder: '000000000000' }
        ]
    },
    'PY': {
        ddi: '+595',
        telefone: { format: 'py', placeholder: '+595 (000) 000-000' },
        documentos: [
            { value: 'ruc', label: 'RUC (Pessoa Jur√≠dica)', maxLength: 10, placeholder: '0000000-0' }
        ]
    },
    'CL': {
        ddi: '+56',
        telefone: { format: 'cl', placeholder: '+56 9 0000 0000' },
        documentos: [
            { value: 'rut_empresa', label: 'RUT (Pessoa Jur√≠dica)', maxLength: 12, placeholder: '00.000.000-0' }
        ]
    },
    'CO': {
        ddi: '+57',
        telefone: { format: 'co', placeholder: '+57 300 000 0000' },
        documentos: [
            { value: 'nit', label: 'NIT (Pessoa Jur√≠dica)', maxLength: 12, placeholder: '000.000.000-0' }
        ]
    },
    'PE': {
        ddi: '+51',
        telefone: { format: 'pe', placeholder: '+51 000 000 000' },
        documentos: [
            { value: 'ruc', label: 'RUC (Pessoa Jur√≠dica)', maxLength: 11, placeholder: '00000000000' }
        ]
    },
    'BO': {
        ddi: '+591',
        telefone: { format: 'bo', placeholder: '+591 000 00000' },
        documentos: [
            { value: 'nit', label: 'NIT (Pessoa Jur√≠dica)', maxLength: 12, placeholder: '0000000000' }
        ]
    },
    'VE': {
        ddi: '+58',
        telefone: { format: 've', placeholder: '+58 000 000-0000' },
        documentos: [
            { value: 'rif', label: 'RIF (Pessoa Jur√≠dica)', maxLength: 12, placeholder: 'J-00000000-0' }
        ]
    },
    'EC': {
        ddi: '+593',
        telefone: { format: 'ec', placeholder: '+593 00 000 0000' },
        documentos: [
            { value: 'ruc', label: 'RUC (Pessoa Jur√≠dica)', maxLength: 13, placeholder: '0000000000000' }
        ]
    },
    'US': {
        ddi: '+1',
        telefone: { format: 'us', placeholder: '+1 (000) 000-0000' },
        documentos: [
            { value: 'ssn', label: 'SSN (Pessoa F√≠sica)', maxLength: 11, placeholder: '000-00-0000' },
            { value: 'ein', label: 'EIN (Pessoa Jur√≠dica)', maxLength: 12, placeholder: '00-0000000' },
            { value: 'passaporte', label: 'Passaporte', maxLength: 20, placeholder: 'Passaporte' }
        ]
    },
    'ES': {
        ddi: '+34',
        telefone: { format: 'es', placeholder: '+34 000 000 000' },
        documentos: [
            { value: 'nie', label: 'NIE (Pessoa F√≠sica)', maxLength: 10, placeholder: 'X-0000000-A' },
            { value: 'cif', label: 'CIF (Pessoa Jur√≠dica)', maxLength: 10, placeholder: 'A00000000' },
            { value: 'passaporte', label: 'Passaporte', maxLength: 20, placeholder: 'Passaporte' }
        ]
    },
    'PT': {
        ddi: '+351',
        telefone: { format: 'pt', placeholder: '+351 000 000 000' },
        documentos: [
            { value: 'nif', label: 'NIF (Pessoa F√≠sica)', maxLength: 11, placeholder: '000000000' },
            { value: 'nif_empresa', label: 'NIF (Pessoa Jur√≠dica)', maxLength: 11, placeholder: '000000000' },
            { value: 'passaporte', label: 'Passaporte', maxLength: 20, placeholder: 'Passaporte' }
        ]
    },
    'OUTRO': {
        ddi: '',
        telefone: { format: 'outro', placeholder: 'Digite o telefone com DDI' },
        documentos: [
            { value: 'passaporte', label: 'Passaporte', maxLength: 30, placeholder: 'Passaporte' },
            { value: 'outro', label: 'Outro', maxLength: 30, placeholder: 'Documento' }
        ]
    },
{% include 'admin/paises_js_config.html' %}
};

function atualizarCamposPorPais() {
    const pais = document.getElementById('pais').value;
    const campoPaisOutro = document.getElementById('campo_pais_outro');
    const inputTelefone = document.getElementById('telefone');
    const selectTipoDocumento = document.getElementById('tipo_documento');
    const inputDocumento = document.getElementById('documento');
    const telefoneHelp = document.getElementById('telefone_help');
    const documentoHelp = document.getElementById('documento_help');
    
    // Preservar valores existentes ao editar
    const telefoneAtual = inputTelefone.value;
    const tipoDocAtual = selectTipoDocumento.value;
    const documentoAtual = inputDocumento.value;
    
    // Limpar campos apenas se n√£o estiver editando
    {% if not doacao %}
    inputTelefone.value = '';
    selectTipoDocumento.innerHTML = '<option value="">Selecione</option>';
    inputDocumento.value = '';
    {% else %}
    // Ao editar, limpar apenas o select de documentos e reconstruir
    selectTipoDocumento.innerHTML = '<option value="">Selecione</option>';
    {% endif %}
    
    if (!pais) {
        campoPaisOutro.style.display = 'none';
        inputTelefone.placeholder = 'Digite o telefone';
        telefoneHelp.textContent = 'Formato ser√° definido pelo pa√≠s selecionado';
        documentoHelp.textContent = 'Tipos dispon√≠veis conforme o pa√≠s';
        return;
    }
    
    // Campo de pa√≠s outro n√£o √© mais necess√°rio (todos os pa√≠ses est√£o na lista)
    if (campoPaisOutro) {
        campoPaisOutro.style.display = 'none';
        campoPaisOutro.removeAttribute('required');
    }
    
    // Configurar telefone
    if (pais && configPaises[pais]) {
        const config = configPaises[pais];
        inputTelefone.placeholder = config.telefone.placeholder;
        telefoneHelp.textContent = `Formato: ${config.telefone.placeholder}`;
        
        // Se n√£o estiver editando ou o telefone n√£o come√ßar com o DDI, adicionar DDI automaticamente
        {% if not doacao %}
        if (config.ddi && !inputTelefone.value.startsWith(config.ddi)) {
            inputTelefone.value = config.ddi + ' ';
        }
        {% else %}
        // Ao editar, preservar o valor existente se houver
        if (!telefoneAtual && '{{ doacao.telefone }}') {
            inputTelefone.value = '{{ doacao.telefone }}';
        } else if (telefoneAtual) {
            inputTelefone.value = telefoneAtual;
        } else if (config.ddi && !inputTelefone.value.startsWith(config.ddi)) {
            inputTelefone.value = config.ddi + ' ';
        }
        {% endif %}
        
        // Configurar documentos
        config.documentos.forEach(doc => {
            const option = document.createElement('option');
            option.value = doc.value;
            option.textContent = doc.label;
            {% if doacao and doacao.tipo_documento %}
            if ('{{ doacao.tipo_documento }}' === doc.value) {
                option.selected = true;
            }
            {% endif %}
            selectTipoDocumento.appendChild(option);
        });
        
        // Restaurar documento se estava editando
        {% if doacao and doacao.documento %}
        if (!documentoAtual && '{{ doacao.documento }}') {
            inputDocumento.value = '{{ doacao.documento }}';
        } else if (documentoAtual) {
            inputDocumento.value = documentoAtual;
        }
        {% endif %}
        
        documentoHelp.textContent = `Documentos dispon√≠veis: ${config.documentos.map(d => d.label).join(', ')}`;
    }
    
    atualizarMascaraDocumento(false);
}

function atualizarMascaraDocumento(limpar = false) {
    const pais = document.getElementById('pais').value;
    const tipoDocumento = document.getElementById('tipo_documento').value;
    const inputDocumento = document.getElementById('documento');
    
    if (!pais || !configPaises[pais]) {
        inputDocumento.maxLength = 30;
        inputDocumento.placeholder = 'Digite o documento';
        return;
    }
    
    const config = configPaises[pais];
    const documentoConfig = config.documentos.find(d => d.value === tipoDocumento);
    
    // Limpar campo apenas se foi chamado ao mudar o tipo (n√£o ao carregar)
    if (limpar) {
        inputDocumento.value = '';
    }
    
    if (documentoConfig) {
        inputDocumento.maxLength = documentoConfig.maxLength;
        inputDocumento.placeholder = documentoConfig.placeholder;
    } else {
        inputDocumento.maxLength = 30;
        inputDocumento.placeholder = 'Digite o documento';
    }
}

// M√°scaras din√¢micas baseadas no pa√≠s
document.addEventListener('DOMContentLoaded', function() {
    atualizarCampos();
    
    // Se estiver editando, restaurar campos do pa√≠s primeiro
    {% if doacao and doacao.pais %}
    const paisSelectInit = document.getElementById('pais');
    if (paisSelectInit && paisSelectInit.value) {
        // Aguardar um pouco para garantir que o DOM est√° pronto
        setTimeout(function() {
            atualizarCamposPorPais();
        }, 100);
    }
    {% else %}
    atualizarCamposPorPais();
    {% endif %}
    
    const inputDocumento = document.getElementById('documento');
    const tipoDocumento = document.getElementById('tipo_documento');
    const paisSelect = document.getElementById('pais');
    
    // M√°scara de documento
    inputDocumento.addEventListener('input', function(e) {
        const pais = paisSelect.value;
        const tipoDoc = tipoDocumento.value;
        
        if (!pais || !configPaises[pais]) return;
        
        let value = e.target.value.replace(/[^A-Za-z0-9]/g, '');
        const config = configPaises[pais];
        const docConfig = config.documentos.find(d => d.value === tipoDoc);
        
        if (!docConfig) return;
        
        // Aplicar m√°scaras espec√≠ficas por tipo de documento
        if (pais === 'BR') {
            if (tipoDoc === 'rg' && value.length <= 10) {
                value = value.replace(/(\d{2})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1})$/, '$1-$2');
            } else if (tipoDoc === 'cpf' && value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else if (tipoDoc === 'cnpj' && value.length <= 14) {
                value = value.replace(/(\d{2})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1/$2');
                value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
            }
        } else if (pais === 'AR') {
            if ((tipoDoc === 'cuil' || tipoDoc === 'cuit') && value.length <= 11) {
                value = value.replace(/(\d{2})(\d)/, '$1-$2');
                value = value.replace(/(\d{8})(\d{1})$/, '$1-$2');
            }
        } else if (pais === 'CL') {
            if (tipoDoc === 'rut_empresa' && value.length <= 9) {
                value = value.replace(/(\d{2})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1})$/, '$1-$2');
            }
        } else if (pais === 'CO') {
            if (tipoDoc === 'nit' && value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1})$/, '$1-$2');
            }
        } else if (pais === 'PE') {
            if (tipoDoc === 'ruc' && value.length <= 11) {
                // Sem formata√ß√£o para RUC do Peru
            }
        } else if (pais === 'VE') {
            if (tipoDoc === 'rif' && value.length <= 10) {
                value = value.replace(/([A-Z])(\d)/, '$1-$2');
                value = value.replace(/(\d{8})(\d{1})$/, '$1-$2');
            }
        } else if (pais === 'US') {
            if (tipoDoc === 'ssn' && value.length <= 9) {
                value = value.replace(/(\d{3})(\d)/, '$1-$2');
                value = value.replace(/(\d{2})(\d)/, '$1-$2');
            } else if (tipoDoc === 'ein' && value.length <= 9) {
                value = value.replace(/(\d{2})(\d)/, '$1-$2');
            }
        } else if (pais === 'ES') {
            if (tipoDoc === 'nie' && value.length <= 7) {
                // NIE: X + 7 d√≠gitos + letra
            } else if (tipoDoc === 'cif' && value.length <= 8) {
                // CIF: Letra + 7 d√≠gitos
            }
        } else if (pais === 'PT') {
            if ((tipoDoc === 'nif' || tipoDoc === 'nif_empresa') && value.length <= 9) {
                // NIF: 9 d√≠gitos
            }
        }
        
        e.target.value = value;
    });
    
    // M√°scara de telefone baseada no pa√≠s
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            const pais = paisSelect.value;
            if (!pais || !configPaises[pais]) return;
            
            const config = configPaises[pais];
            let value = e.target.value;
            
            // Remover todos os caracteres n√£o num√©ricos exceto espa√ßos, par√™nteses, h√≠fens e +
            let numbers = value.replace(/[^\d]/g, '');
            
            // Aplicar m√°scaras espec√≠ficas por pa√≠s
            if (pais === 'BR') {
                // +55 (00) 00000-0000
                if (numbers.startsWith('55')) {
                    numbers = numbers.substring(2);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' (' + numbers.substring(0, 2);
                        if (numbers.length > 2) {
                            value += ') ' + numbers.substring(2, 7);
                            if (numbers.length > 7) {
                                value += '-' + numbers.substring(7, 11);
                            }
                        } else {
                            value += ')';
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'AR') {
                // +54 (000) 000 0000
                if (numbers.startsWith('54')) {
                    numbers = numbers.substring(2);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' (' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ') ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += ' ' + numbers.substring(6, 10);
                            }
                        } else {
                            value += ')';
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'US') {
                // +1 (000) 000-0000
                if (numbers.startsWith('1')) {
                    numbers = numbers.substring(1);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' (' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ') ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += '-' + numbers.substring(6, 10);
                            }
                        } else {
                            value += ')';
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'CL') {
                // +56 9 0000 0000
                if (numbers.startsWith('56')) {
                    numbers = numbers.substring(2);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 1);
                        if (numbers.length > 1) {
                            value += ' ' + numbers.substring(1, 5);
                            if (numbers.length > 5) {
                                value += ' ' + numbers.substring(5, 9);
                            }
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'UY') {
                // +598 0000 0000
                if (numbers.startsWith('598')) {
                    numbers = numbers.substring(3);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 4);
                        if (numbers.length > 4) {
                            value += ' ' + numbers.substring(4, 8);
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'PY') {
                // +595 (000) 000-000
                if (numbers.startsWith('595')) {
                    numbers = numbers.substring(3);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' (' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ') ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += '-' + numbers.substring(6, 9);
                            }
                        } else {
                            value += ')';
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'CO') {
                // +57 300 000 0000
                if (numbers.startsWith('57')) {
                    numbers = numbers.substring(2);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ' ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += ' ' + numbers.substring(6, 10);
                            }
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'PE') {
                // +51 000 000 000
                if (numbers.startsWith('51')) {
                    numbers = numbers.substring(2);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ' ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += ' ' + numbers.substring(6, 9);
                            }
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'BO') {
                // +591 000 00000
                if (numbers.startsWith('591')) {
                    numbers = numbers.substring(3);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ' ' + numbers.substring(3, 8);
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'VE') {
                // +58 000 000-0000
                if (numbers.startsWith('58')) {
                    numbers = numbers.substring(2);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ' ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += '-' + numbers.substring(6, 10);
                            }
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'EC') {
                // +593 00 000 0000
                if (numbers.startsWith('593')) {
                    numbers = numbers.substring(3);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 2);
                        if (numbers.length > 2) {
                            value += ' ' + numbers.substring(2, 5);
                            if (numbers.length > 5) {
                                value += ' ' + numbers.substring(5, 9);
                            }
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'ES') {
                // +34 000 000 000
                if (numbers.startsWith('34')) {
                    numbers = numbers.substring(2);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ' ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += ' ' + numbers.substring(6, 9);
                            }
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (pais === 'PT') {
                // +351 000 000 000
                if (numbers.startsWith('351')) {
                    numbers = numbers.substring(3);
                }
                if (numbers.length > 0) {
                    value = config.ddi;
                    if (numbers.length > 0) {
                        value += ' ' + numbers.substring(0, 3);
                        if (numbers.length > 3) {
                            value += ' ' + numbers.substring(3, 6);
                            if (numbers.length > 6) {
                                value += ' ' + numbers.substring(6, 9);
                            }
                        }
                    }
                } else {
                    value = config.ddi + ' ';
                }
            } else if (config.telefone.format === 'generico') {
                // Formato gen√©rico para pa√≠ses sem m√°scara espec√≠fica
                if (numbers.length > 0) {
                    // Remover DDI se j√° estiver presente
                    const ddiDigits = config.ddi.replace(/[^0-9]/g, '');
                    if (numbers.startsWith(ddiDigits)) {
                        numbers = numbers.substring(ddiDigits.length);
                    }
                    value = config.ddi + ' ' + numbers;
                } else {
                    value = config.ddi + ' ';
                }
            } else {
                // Para outros pa√≠ses, manter o valor como est√°
                if (config.ddi && !value.startsWith(config.ddi)) {
                    value = config.ddi + ' ' + value;
                }
            }
            
            e.target.value = value;
        });
        
        // Ao perder o foco, garantir que o DDI est√° presente
        telefoneInput.addEventListener('blur', function(e) {
            const pais = paisSelect.value;
            if (pais && configPaises[pais] && configPaises[pais].ddi) {
                const ddi = configPaises[pais].ddi;
                let value = e.target.value.trim();
                if (value && !value.startsWith(ddi)) {
                    // Se n√£o come√ßar com o DDI, adicionar
                    const numbers = value.replace(/\D/g, '');
                    if (numbers.length > 0) {
                        e.target.value = ddi + ' ' + numbers;
                    } else {
                        e.target.value = ddi + ' ';
                    }
                } else if (!value) {
                    e.target.value = ddi + ' ';
                }
            }
        });
    }
    
    // Validar antes de submeter
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const pais = paisSelect.value;
            // Valida√ß√£o de pa√≠s removida - todos os pa√≠ses est√£o na lista
        });
    }
});
</script>
{% endblock %}

